#!/bin/bash

# Pre-commit hook for Activity Hub
# Enforces styling standards and prevents drift

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo "ğŸ” Running Activity Hub pre-commit checks..."

ERRORS=0
WARNINGS=0

# Check for app-specific CSS files FIRST (blocks all commits if found)
echo ""
echo "Checking for app-specific CSS files..."
APP_CSS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'games/.*/frontend/.*\.css$' || true)
if [ ! -z "$APP_CSS_FILES" ]; then
    echo -e "${RED}âŒ ERROR: Found app-specific CSS files (use shared Activity Hub CSS only):${NC}"
    echo "$APP_CSS_FILES"
    echo -e "${YELLOW}   Apps must use ONLY shared CSS from identity-shell${NC}"
    echo -e "${YELLOW}   Loaded dynamically via: http://\${window.location.hostname}:3001/shared/activity-hub.css${NC}"
    echo -e "${YELLOW}   Use Activity Hub classes (.ah-*) instead of custom CSS${NC}"
    echo -e "${YELLOW}   If you need new styles, add them to lib/activity-hub-common/styles/activity-hub-src.css${NC}"
    ERRORS=$((ERRORS + 1))
fi

# Get list of staged .tsx and .ts files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(tsx?)$')

if [ -z "$STAGED_FILES" ]; then
    # No TypeScript files, but we still need to check if there were errors from CSS check
    if [ $ERRORS -gt 0 ]; then
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo -e "${RED}âŒ Pre-commit check FAILED with $ERRORS error(s)${NC}"
        echo -e "${YELLOW}   Fix the errors above and try again${NC}"
        exit 1
    fi
    echo "âœ… No TypeScript files to check"
    exit 0
fi

# Check 1: Verify index.tsx files have Activity Hub CSS loading
echo ""
echo "Checking for Activity Hub CSS loading..."
for FILE in $STAGED_FILES; do
    if [[ $FILE == *"index.tsx" ]] && [[ $FILE == *"frontend/src/index.tsx" ]]; then
        if ! grep -q "activity-hub.css" "$FILE"; then
            echo -e "${RED}âŒ ERROR: $FILE missing Activity Hub CSS loading${NC}"
            echo -e "${YELLOW}   Add this code:${NC}"
            echo "   const link = document.createElement('link');"
            echo "   link.rel = 'stylesheet';"
            echo "   link.href = \`http://\${window.location.hostname}:3001/shared/activity-hub.css\`;"
            echo "   document.head.appendChild(link);"
            ERRORS=$((ERRORS + 1))
        else
            echo -e "${GREEN}âœ“${NC} $FILE"
        fi
    fi
done

# Check 2: Warn about hardcoded colors
echo ""
echo "Checking for hardcoded colors..."
for FILE in $STAGED_FILES; do
    # Look for hex colors in the file
    HEX_COLORS=$(grep -n '#[0-9a-fA-F]\{3,8\}' "$FILE" 2>/dev/null || true)
    if [ ! -z "$HEX_COLORS" ]; then
        echo -e "${YELLOW}âš ï¸  WARNING: $FILE contains hardcoded colors:${NC}"
        echo "$HEX_COLORS" | head -3
        echo -e "${YELLOW}   Consider using Activity Hub classes instead${NC}"
        WARNINGS=$((WARNINGS + 1))
    fi
done

# Check 3: Look for common inline style patterns
echo ""
echo "Checking for inline styles that should use Activity Hub classes..."
for FILE in $STAGED_FILES; do
    # Check for style={{ patterns
    INLINE_STYLES=$(grep -n 'style={{' "$FILE" 2>/dev/null || true)
    if [ ! -z "$INLINE_STYLES" ]; then
        STYLE_COUNT=$(echo "$INLINE_STYLES" | wc -l | xargs)
        if [ "$STYLE_COUNT" -gt 3 ]; then
            echo -e "${YELLOW}âš ï¸  WARNING: $FILE has $STYLE_COUNT inline style declarations${NC}"
            echo -e "${YELLOW}   Consider using Activity Hub classes (.ah-*) instead${NC}"
            WARNINGS=$((WARNINGS + 1))
        fi
    fi
done

# Check 4: Verify TypeScript files (not .js)
echo ""
echo "Checking file extensions..."
JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'frontend/src/.*\.jsx?$' || true)
if [ ! -z "$JS_FILES" ]; then
    echo -e "${RED}âŒ ERROR: Found .js/.jsx files in frontend/src (should be .ts/.tsx):${NC}"
    echo "$JS_FILES"
    echo -e "${YELLOW}   All React files must use TypeScript (.tsx)${NC}"
    ERRORS=$((ERRORS + 1))
fi

# Check 4b: No CSS imports in TypeScript files
echo ""
echo "Checking for CSS imports in TypeScript..."
for FILE in $STAGED_FILES; do
    CSS_IMPORTS=$(grep -n "import.*\.css" "$FILE" 2>/dev/null || true)
    if [ ! -z "$CSS_IMPORTS" ]; then
        echo -e "${RED}âŒ ERROR: $FILE imports CSS files${NC}"
        echo "$CSS_IMPORTS"
        echo -e "${YELLOW}   Remove CSS imports - use Activity Hub classes (.ah-*) only${NC}"
        echo -e "${YELLOW}   Shared CSS loaded automatically in index.tsx${NC}"
        echo -e "${YELLOW}   If you need new styles, add them to lib/activity-hub-common/styles/activity-hub-src.css${NC}"
        ERRORS=$((ERRORS + 1))
    fi
done

# Check 5: SQL migrations must use {host} placeholder, not localhost
echo ""
echo "Checking SQL migrations for localhost..."
SQL_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'scripts/.*\.sql$' || true)
for FILE in $SQL_FILES; do
    # Check for localhost in URL values (not in comments)
    LOCALHOST_URLS=$(grep -E "http://localhost:[0-9]+" "$FILE" 2>/dev/null | grep -v '^[[:space:]]*--' || true)
    if [ ! -z "$LOCALHOST_URLS" ]; then
        echo -e "${RED}âŒ ERROR: $FILE contains localhost in URLs${NC}"
        echo "$LOCALHOST_URLS"
        echo -e "${YELLOW}   Use {host} placeholder instead: http://{host}:PORT${NC}"
        echo -e "${YELLOW}   Identity shell will replace {host} with actual hostname${NC}"
        ERRORS=$((ERRORS + 1))
    fi
done

# Summary
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}âŒ Pre-commit check FAILED with $ERRORS error(s)${NC}"
    echo -e "${YELLOW}   Fix the errors above and try again${NC}"
    exit 1
elif [ $WARNINGS -gt 0 ]; then
    echo -e "${YELLOW}âš ï¸  Pre-commit check PASSED with $WARNINGS warning(s)${NC}"
    echo -e "${GREEN}   Warnings don't block commits, but consider addressing them${NC}"
    exit 0
else
    echo -e "${GREEN}âœ… All pre-commit checks passed!${NC}"
    exit 0
fi
